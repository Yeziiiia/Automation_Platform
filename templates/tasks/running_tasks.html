{% extends 'base.html' %}
{% load static %}

{% block title %}任务运行{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'tasks/css/tasks.css' %}">
{% endblock %}

{% block banner %}
<section class="banner">
    <h1>正在运行的任务</h1>
</section>
{% endblock %}

{% block content %}
<div class="task-grid" id="taskGrid">
    {% for t in tasks %}
    <div class="task-card" data-task-id="{{ t.id }}">
        <div class="task-header">
            <span class="task-name">{{ t.name }}</span>
            <span class="task-status {{ t.status }}">{{ t.get_status_display }}</span>
        </div>
        <div class="task-info">
            <p>{{ t.devices|length }} 个设备</p>
            <p class="runtime">运行时间: {{ t.runtime }}</p>
        </div>
        {% if t.status == 'running' %}
        <div class="progress-bar">
            <div class="progress" style="width: {{ t.progress }}%"></div>
        </div>
        {% endif %}
        <button class="btn btn-blue btn-block">查看详情</button>
    </div>
    {% endfor %}
</div>

<!-- 固定底部分页组件 -->
{% include 'components/pagination.html' with page_obj=tasks aria_label='任务列表分页' %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 任务状态更新管理器
    class TaskStatusManager {
        constructor() {
            this.updateInterval = null;
            this.runningTasks = new Set();
            this.init();
        }

        init() {
            // 找出所有运行中的任务
            this.findRunningTasks();

            // 如果有运行中的任务，开始定期更新
            if (this.runningTasks.size > 0) {
                this.startAutoUpdate();
            }
        }

        findRunningTasks() {
            const taskCards = document.querySelectorAll('.task-card');
            taskCards.forEach(card => {
                const taskId = card.dataset.taskId;
                const statusElement = card.querySelector('.task-status');
                if (statusElement && statusElement.classList.contains('running')) {
                    this.runningTasks.add(parseInt(taskId));
                }
            });
        }

        startAutoUpdate() {
            // 每60秒更新一次
            this.updateInterval = setInterval(() => {
                this.updateAllTasks();
            }, 60000);

            // 每5秒更新运行中的任务进度
            this.progressInterval = setInterval(() => {
                this.updateRunningTasksProgress();
            }, 5000);
        }

        stopAutoUpdate() {
            if (this.updateInterval) {
                clearInterval(this.updateInterval);
                this.updateInterval = null;
            }
            if (this.progressInterval) {
                clearInterval(this.progressInterval);
                this.progressInterval = null;
            }
        }

        updateAllTasks() {
            fetch('/tasks/api/status/all/', {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.updateTaskCards(data.tasks);
                }
            })
            .catch(error => {
                console.error('更新任务状态失败:', error);
            });
        }

        updateRunningTasksProgress() {
            if (this.runningTasks.size === 0) {
                this.stopAutoUpdate();
                return;
            }

            this.runningTasks.forEach(taskId => {
                fetch(`/tasks/api/status/${taskId}/`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.updateTaskCard(data.task);
                    }
                })
                .catch(error => {
                    console.error(`更新任务 ${taskId} 失败:`, error);
                });
            });
        }

        updateTaskCards(tasks) {
            tasks.forEach(task => {
                this.updateTaskCard(task);
            });
        }

        updateTaskCard(task) {
            const card = document.querySelector(`[data-task-id="${task.id}"]`);
            if (!card) return;

            // 更新状态
            const statusElement = card.querySelector('.task-status');
            if (statusElement) {
                statusElement.className = `task-status ${task.status}`;
                statusElement.textContent = task.status_display;
            }

            // 更新运行时间
            const runtimeElement = card.querySelector('.runtime');
            if (runtimeElement) {
                runtimeElement.textContent = `运行时间: ${task.runtime}`;
            }

            // 更新进度条
            const progressBar = card.querySelector('.progress-bar');
            const progress = card.querySelector('.progress');

            if (task.status === 'running') {
                if (!progressBar) {
                    // 如果没有进度条，创建一个
                    const taskInfo = card.querySelector('.task-info');
                    const newProgressBar = document.createElement('div');
                    newProgressBar.className = 'progress-bar';
                    newProgressBar.innerHTML = '<div class="progress" style="width: 0%"></div>';
                    taskInfo.parentNode.insertBefore(newProgressBar, taskInfo.nextSibling);
                }

                // 平滑更新进度
                const currentProgress = progress ? parseInt(progress.style.width) : 0;
                this.animateProgress(progress || progressBar.querySelector('.progress'), currentProgress, task. Progress);
            } else {
                // 任务完成，移除进度条
                if (progressBar) {
                    progressBar.remove();
                }

                // 从运行中任务列表移除
                this.runningTasks.delete(task.id);

                // 如果没有运行中的任务了，停止更新
                if (this.runningTasks.size === 0) {
                    this.stopAutoUpdate();
                }
            }
        }

        animateProgress(element, from, to) {
            const duration = 1000; // 1秒动画
            const startTime = performance.now();

            const animate = (currentTime) => {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                const currentValue = from + (to - from) * this.easeInOutQuad(progress);
                element.style.width = `${currentValue}%`;

                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            };

            requestAnimationFrame(animate);
        }

        easeInOutQuad(t) {
            return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
        }
    }

    // 初始化任务状态管理器
    const taskManager = new TaskStatusManager();

    // 页面卸载时清理
    window.addEventListener('beforeunload', () => {
        taskManager.stopAutoUpdate();
    });
});
</script>
{% endblock %}