<!-- 设备状态大弹窗 -->
<div class="modal fade" id="deviceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-wider modal-dialog-centered">
    <div class="modal-content shadow-lg rounded-4">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold text-primary">设备状态</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <div class="modal-body">
        <!-- 统计卡片 -->
        <div class="row g-3 mb-4">
          <div class="col">
            <div class="card stat-card-modal">
              <div class="card-body text-center">
                <div class="display-6 fw-bold text-primary">{{ stats.total }}</div>
                <div class="text-muted">设备总数</div>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card stat-card-modal">
              <div class="card-body text-center">
                <div class="display-6 fw-bold text-success">{{ stats.online }}</div>
                <div class="text-muted">在线设备</div>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card stat-card-modal">
              <div class="card-body text-center">
                <div class="display-6 fw-bold text-warning">{{ stats.offline }}</div>
                <div class="text-muted">离线设备</div>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card stat-card-modal">
              <div class="card-body text-center">
                <div class="display-6 fw-bold text-info">{{ stats.android }}</div>
                <div class="text-muted">Android 设备</div>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card stat-card-modal">
              <div class="card-body text-center">
                <div class="display-6 fw-bold text-secondary">{{ stats.ios }}</div>
                <div class="text-muted">iOS 设备</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 设备表格 -->
        <div class="table-responsive">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">已连接设备</h6>
            <div class="d-flex align-items-center">
              <small class="text-muted me-2">自动刷新</small>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
                <label class="form-check-label" for="autoRefreshToggle"></label>
              </div>
              <button class="btn btn-sm btn-outline-primary ms-2" id="manualRefreshBtn">
                <i class="bi bi-arrow-clockwise"></i> 刷新
              </button>
            </div>
          </div>
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>设备名称</th>
                <th>设备ID</th>
                <th>系统版本</th>
                <th>连接状态</th>
                <th>连接类型</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="deviceTableBody">
              {% for device in devices %}
              <tr>
                <td>{{ device.name }}</td>
                <td><small>{{ device.device_id }}</small></td>
                <td>{{ device.os }}</td>
                <td>
                  {% if device.status == "在线" %}
                    <span class="badge bg-success rounded-pill">在线</span>
                  {% else %}
                    <span class="badge bg-secondary rounded-pill">离线</span>
                  {% endif %}
                </td>
                <td>{{ device.conn }}</td>
                <td>
                  {% if device.status == "在线" %}
                    <button class="btn btn-sm btn-outline-primary rounded-pill">调试</button>
                  {% else %}
                    <button class="btn btn-sm btn-outline-secondary rounded-pill" disabled>调试</button>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted py-4">
                  <div class="mb-2">
                    <i class="bi bi-phone-x" style="font-size: 2rem;"></i>
                  </div>
                  <div>未检测到已连接的设备</div>
                  <small class="text-muted">请确保设备已连接并已启用USB调试模式</small>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer border-0">
        <div class="d-flex justify-content-start w-100">
          <small class="text-muted" id="lastUpdateTime">最后更新: --</small>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// 设备状态弹窗自动刷新功能
(function() {
    let refreshInterval = null;
    let isModalOpen = false;
    let autoRefreshEnabled = true;

    // 更新设备表格
    function updateDeviceTable(devices, stats) {
        const tbody = document.getElementById('deviceTableBody');
        const lastUpdateTime = document.getElementById('lastUpdateTime');

        // 更新统计卡片
        updateStatCards(stats);

        // 更新表格内容
        if (devices.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        <div class="mb-2">
                            <i class="bi bi-phone-x" style="font-size: 2rem;"></i>
                        </div>
                        <div>未检测到已连接的设备</div>
                        <small class="text-muted">请确保设备已连接并已启用USB调试模式</small>
                    </td>
                </tr>
            `;
        } else {
            tbody.innerHTML = devices.map(device => `
                <tr>
                    <td>${device.name}</td>
                    <td><small>${device.device_id}</small></td>
                    <td>${device.os}</td>
                    <td>
                        ${device.status === '在线'
                            ? '<span class="badge bg-success rounded-pill">在线</span>'
                            : '<span class="badge bg-secondary rounded-pill">离线</span>'
                        }
                    </td>
                    <td>${device.conn}</td>
                    <td>
                        ${device.status === '在线'
                            ? '<button class="btn btn-sm btn-outline-primary rounded-pill">调试</button>'
                            : '<button class="btn btn-sm btn-outline-secondary rounded-pill" disabled>调试</button>'
                        }
                    </td>
                </tr>
            `).join('');
        }

        // 更新最后更新时间
        const now = new Date();
        lastUpdateTime.textContent = `最后更新: ${now.toLocaleTimeString()}`;
    }

    // 更新统计卡片
    function updateStatCards(stats) {
        const statCards = document.querySelectorAll('.stat-card-modal .display-6');
        if (statCards.length >= 5) {
            statCards[0].textContent = stats.total;
            statCards[1].textContent = stats.online;
            statCards[2].textContent = stats.offline;
            statCards[3].textContent = stats.android;
            statCards[4].textContent = stats.ios;
        }
    }

    // 刷新设备数据
    function refreshDevices() {
        fetch('/cases/devices/', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateDeviceTable(data.devices, data.stats);
            }
        })
        .catch(error => {
            console.error('刷新设备数据失败:', error);
        });
    }

    // 启动自动刷新
    function startAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }

        if (autoRefreshEnabled && isModalOpen) {
            refreshInterval = setInterval(refreshDevices, 30000); // 30秒刷新一次
        }
    }

    // 停止自动刷新
    function stopAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
    }

    // 监听弹窗显示事件
    const deviceModal = document.getElementById('deviceModal');
    if (deviceModal) {
        deviceModal.addEventListener('show.bs.modal', function() {
            isModalOpen = true;
            refreshDevices(); // 立即刷新一次
            startAutoRefresh(); // 启动自动刷新
        });

        deviceModal.addEventListener('hide.bs.modal', function() {
            isModalOpen = false;
            stopAutoRefresh(); // 停止自动刷新
        });
    }

    // 自动刷新开关
    const autoRefreshToggle = document.getElementById('autoRefreshToggle');
    if (autoRefreshToggle) {
        autoRefreshToggle.addEventListener('change', function() {
            autoRefreshEnabled = this.checked;
            if (autoRefreshEnabled && isModalOpen) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });
    }

    // 手动刷新按钮
    const manualRefreshBtn = document.getElementById('manualRefreshBtn');
    if (manualRefreshBtn) {
        manualRefreshBtn.addEventListener('click', function() {
            refreshDevices();
        });
    }
})();
</script>