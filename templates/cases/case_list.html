{% extends 'base.html' %}
{% load static %}

{% block title %}用例管理{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'cases/css/cases.css' %}">
{% endblock %}

{% block banner %}
<section class="banner">
    <h1>用例管理</h1>
</section>
{% endblock %}

{% block content %}
<div class="page-actions">
    <button class="btn btn-success rounded-pill" data-bs-toggle="modal" data-bs-target="#deviceModal">设备状态</button>
    <button class="btn btn-primary rounded-pill" data-bs-toggle="modal" data-bs-target="#uploadModal">上传用例</button>
</div>

<table class="data-table">
    <thead>
        <tr>
            <th>脚本名称</th>
            <th>文件类型</th>
            <th>文件大小</th>
            <th>上传时间</th>
            <th>状态</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>
        {% for case in cases %}
        <tr>
            <td>{{ case.name }}</td>
            <td>
                <span class="file-type-badge {{ case.file_type }}">
                    {{ case.get_file_type_display }}
                </span>
            </td>
            <td>{{ case.get_file_size_display }}</td>
            <td>{{ case.upload_time|date:"Y/m/d H:i:s" }}</td>
            <td>
                <span class="status {{ case.status }}">
                    {{ case.get_status_display }}
                </span>
            </td>
            <td class="actions">
                <button class="btn btn-blue">运行</button>
                <button class="btn btn-gray edit-btn" data-id="{{ case.id }}" data-name="{{ case.name }}" data-status="{{ case.status }}">编辑</button>
                <button class="btn btn-red delete-btn" data-id="{{ case.id }}" data-name="{{ case.name }}">删除</button>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" class="text-center text-muted py-4">
                暂无测试用例，请点击"上传用例"按钮上传。
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- 固定底部分页组件 -->
{% include 'components/pagination.html' with page_obj=cases aria_label='用例列表分页' %}

<!-- 编辑测试用例内联模态框 -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg rounded-4">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold text-primary">编辑测试用例</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <form method="post" id="editForm">
        {% csrf_token %}
        <input type="hidden" id="editCaseId" name="case_id">
        <div class="modal-body">
          <div class="mb-3">
            <label for="editName" class="form-label">脚本名称 <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="editName" name="name" required>
          </div>

          <div class="mb-3">
            <label for="editStatus" class="form-label">状态 <span class="text-danger">*</span></label>
            <select class="form-select" id="editStatus" name="status" required>
              <option value="available">可用</option>
              <option value="unavailable">不可用</option>
            </select>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary rounded-pill px-3" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary rounded-pill px-3" id="editSaveBtn">
            <span id="editSaveBtnText">保存</span>
            <span id="editSaveSpinner" class="spinner-border spinner-border-sm d-none" role="status">
              <span class="visually-hidden">保存中...</span>
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg rounded-4">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold text-danger">确认删除</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <div class="modal-body">
        <p>确定要删除测试用例 "<strong id="deleteCaseName"></strong>" 吗？</p>
        <p class="text-muted small">此操作不可撤销，文件将被永久删除。</p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary rounded-pill px-3" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-danger rounded-pill px-3" id="confirmDeleteBtn">
          <span id="deleteBtnText">确定删除</span>
          <span id="deleteSpinner" class="spinner-border spinner-border-sm d-none" role="status">
            <span class="visually-hidden">删除中...</span>
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 文件上传模态框 -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg rounded-4">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold text-primary">上传测试用例</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <form method="post" enctype="multipart/form-data" id="uploadForm">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label for="{{ form.name.id_for_label }}" class="form-label">脚本名称 <span class="text-danger">*</span></label>
            {{ form.name }}
            {% if form.name.errors %}
              <div class="text-danger small mt-1">
                {% for error in form.name.errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <div class="mb-3">
            <label for="{{ form.file.id_for_label }}" class="form-label">选择文件 <span class="text-danger">*</span></label>
            {{ form.file }}
            <div class="form-text">{{ form.file.help_text }}</div>
            {% if form.file.errors %}
              <div class="text-danger small mt-1">
                {% for error in form.file.errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <div class="mb-3">
            <label for="{{ form.status.id_for_label }}" class="form-label">状态 <span class="text-danger">*</span></label>
            {{ form.status }}
            {% if form.status.errors %}
              <div class="text-danger small mt-1">
                {% for error in form.status.errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <div class="alert alert-info small">
            <i class="bi bi-info-circle"></i>
            <strong>支持格式：</strong>Python脚本文件 (.py) 和 Airtest脚本文件（把.air压缩为ZIP上传）<br>
            <strong>文件大小限制：</strong>最大10MB
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary rounded-pill px-3" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary rounded-pill px-3" id="uploadBtn">
            <span id="uploadBtnText">上传</span>
            <span id="uploadSpinner" class="spinner-border spinner-border-sm d-none" role="status">
              <span class="visually-hidden">上传中...</span>
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // 上传功能
  const uploadForm = document.getElementById('uploadForm');
  const uploadBtn = document.getElementById('uploadBtn');
  const uploadBtnText = document.getElementById('uploadBtnText');
  const uploadSpinner = document.getElementById('uploadSpinner');

  uploadForm.addEventListener('submit', function(e) {
    e.preventDefault();

    // 显示上传状态
    uploadBtn.disabled = true;
    uploadBtnText.textContent = '上传中...';
    uploadSpinner.classList.remove('d-none');

    const formData = new FormData(uploadForm);

    fetch('{% url "cases:case_list" %}', {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('uploadModal'));
        modal.hide();

        // 显示成功消息
        showAlert(data.message, 'success');

        // 刷新页面
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      } else {
        showAlert(data.message, 'danger');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showAlert('上传失败，请重试', 'danger');
    })
    .finally(() => {
      // 恢复按钮状态
      uploadBtn.disabled = false;
      uploadBtnText.textContent = '上传';
      uploadSpinner.classList.add('d-none');
    });
  });

  // 编辑功能
  const editModal = new bootstrap.Modal(document.getElementById('editModal'));
  const editForm = document.getElementById('editForm');
  const editSaveBtn = document.getElementById('editSaveBtn');
  const editSaveBtnText = document.getElementById('editSaveBtnText');
  const editSaveSpinner = document.getElementById('editSaveSpinner');
  let currentEditId = null;

  // 编辑按钮点击事件
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.dataset.id;
      const name = this.dataset.name;
      const status = this.dataset.status;

      currentEditId = id;
      document.getElementById('editCaseId').value = id;
      document.getElementById('editName').value = name;
      document.getElementById('editStatus').value = status;

      editModal.show();
    });
  });

  // 编辑表单提交
  editForm.addEventListener('submit', function(e) {
    e.preventDefault();

    if (!currentEditId) return;

    // 显示保存状态
    editSaveBtn.disabled = true;
    editSaveBtnText.textContent = '保存中...';
    editSaveSpinner.classList.remove('d-none');

    const formData = new FormData(editForm);

    fetch(`/cases/edit/${currentEditId}/`, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        editModal.hide();
        showAlert(data.message, 'success');

        // 更新页面显示
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      } else {
        showAlert(data.message, 'danger');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showAlert('保存失败，请重试', 'danger');
    })
    .finally(() => {
      // 恢复按钮状态
      editSaveBtn.disabled = false;
      editSaveBtnText.textContent = '保存';
      editSaveSpinner.classList.add('d-none');
    });
  });

  // 删除功能
  const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
  const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
  const deleteBtnText = document.getElementById('deleteBtnText');
  const deleteSpinner = document.getElementById('deleteSpinner');
  let currentDeleteId = null;
  let currentDeleteName = null;

  // 删除按钮点击事件
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.dataset.id;
      const name = this.dataset.name;

      currentDeleteId = id;
      currentDeleteName = name;
      document.getElementById('deleteCaseName').textContent = name;

      deleteModal.show();
    });
  });

  // 确认删除按钮点击事件
  confirmDeleteBtn.addEventListener('click', function() {
    if (!currentDeleteId) return;

    // 显示删除状态
    confirmDeleteBtn.disabled = true;
    deleteBtnText.textContent = '删除中...';
    deleteSpinner.classList.remove('d-none');

    fetch(`/cases/delete/${currentDeleteId}/`, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        deleteModal.hide();
        showAlert(data.message, 'success');

        // 从页面中移除该行
        setTimeout(() => {
          const row = document.querySelector(`[data-id="${currentDeleteId}"]`).closest('tr');
          if (row) {
            row.remove();
          }

          // 检查是否需要刷新页面（如果当前页没有数据了）
          const tbody = document.querySelector('.data-table tbody');
          if (tbody && tbody.children.length === 0) {
            window.location.reload();
          }
        }, 1500);
      } else {
        showAlert(data.message, 'danger');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showAlert('删除失败，请重试', 'danger');
    })
    .finally(() => {
      // 恢复按钮状态
      confirmDeleteBtn.disabled = false;
      deleteBtnText.textContent = '确定删除';
      deleteSpinner.classList.add('d-none');
    });
  });

  function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-50 start-50 translate-middle`;
    alertDiv.style.zIndex = '9999';
    alertDiv.style.minWidth = '300px';
    alertDiv.style.textAlign = 'center';
    alertDiv.innerHTML = `
      ${message}
    `;
    document.body.appendChild(alertDiv);

    // 4秒后自动移除提示
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.classList.remove('show');
        setTimeout(() => {
          if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
          }
        }, 150);
      }
    }, 4000);
  }
});
</script>
{% endblock %}